--[[

CTF Challenge LASM ( https://github.com/lasm-project/ctf )

- [ LuaAssembly Project ] -

------------ [ LICENSE ] ------------

Creative Commons Attribution-NonCommercial-NoDerivatives 4.0 International

This work is licensed under the terms of the Creative Commons BY-NC-ND 4.0 license.
You may view a copy of the license at https://creativecommons.org/licenses/by-nc-nd/4.0/

You may use, reverse-engineer, and study this repository for educational and non-commercial purposes only.
No derivative works are permitted without explicit permission.

]]

local INPUT_STRING = "Enter a string you want to encrypt";

(function()local b;local c={[2]=function(a)local c=a:r("B")if c~=64 then error("[lasm - error(12)]")end;local a=b(a)return{bT=c,c=a}end,[3]=function(a)local c=a:r("B")if c~=64 then error("[lasm - error(12)]")end;local a=b(a)return{bT=c,c=a}end,[12]=function(a)return{l=a:rL128()}end,[13]=function(a)return{l=a:rL128()}end,[15]=function(a)return{}end,[16]=function(a)return{x=a:rL128()}end,[32]=function(a)return{x=a:rL128()}end,[33]=function(a)return{x=a:rL128()}end,[34]=function(a)return{x=a:rL128()}end,[35]=function(a)return{x=a:rL128()}end,[36]=function(a)return{x=a:rL128()}end,[40]=function(a)return{m={a=a:rL128(),o=a:rL128()}}end,[41]=function(a)return{m={a=a:rL128(),o=a:rL128()}}end,[42]=function(a)return{m={a=a:rL128(),o=a:rL128()}}end,[43]=function(a)return{m={a=a:rL128(),o=a:rL128()}}end,[44]=function(a)return{m={a=a:rL128(),o=a:rL128()}}end,[45]=function(a)return{m={a=a:rL128(),o=a:rL128()}}end,[46]=function(a)return{m={a=a:rL128(),o=a:rL128()}}end,[47]=function(a)return{m={a=a:rL128(),o=a:rL128()}}end,[48]=function(a)return{m={a=a:rL128(),o=a:rL128()}}end,[49]=function(a)return{m={a=a:rL128(),o=a:rL128()}}end,[50]=function(a)return{m={a=a:rL128(),o=a:rL128()}}end,[51]=function(a)return{m={a=a:rL128(),o=a:rL128()}}end,[52]=function(a)return{m={a=a:rL128(),o=a:rL128()}}end,[53]=function(a)return{m={a=a:rL128(),o=a:rL128()}}end,[54]=function(a)return{m={a=a:rL128(),o=a:rL128()}}end,[55]=function(a)return{m={a=a:rL128(),o=a:rL128()}}end,[56]=function(a)return{m={a=a:rL128(),o=a:rL128()}}end,[57]=function(a)return{m={a=a:rL128(),o=a:rL128()}}end,[58]=function(a)return{m={a=a:rL128(),o=a:rL128()}}end,[59]=function(a)return{m={a=a:rL128(),o=a:rL128()}}end,[60]=function(a)return{m={a=a:rL128(),o=a:rL128()}}end,[61]=function(a)return{m={a=a:rL128(),o=a:rL128()}}end,[62]=function(a)return{m={a=a:rL128(),o=a:rL128()}}end,[65]=function(a)return{v=a:rL128(true)}end,[66]=function(a)return{v=a:rL128(true)}end,[67]=function(a)return{v=string.unpack("<f",string.pack("<I4",a:r("<I4")))}end,[68]=function(a)return{v=string.unpack("<f",string.pack("<I8",a:r("<I8")))}end,[69]=function()return{}end,[70]=function()return{}end,[71]=function()return{}end,[72]=function()return{}end,[73]=function()return{}end,[74]=function()return{}end,[75]=function()return{}end,[76]=function()return{}end,[77]=function()return{}end,[78]=function()return{}end,[79]=function()return{}end,[80]=function()return{}end,[81]=function()return{}end,[82]=function()return{}end,[83]=function()return{}end,[84]=function()return{}end,[85]=function()return{}end,[86]=function()return{}end,[87]=function()return{}end,[88]=function()return{}end,[89]=function()return{}end,[90]=function()return{}end,[91]=function()return{}end,[92]=function()return{}end,[93]=function()return{}end,[94]=function()return{}end,[95]=function()return{}end,[96]=function()return{}end,[97]=function()return{}end,[98]=function()return{}end,[99]=function()return{}end,[100]=function()return{}end,[101]=function()return{}end,[102]=function()return{}end,[103]=function()return{}end,[104]=function()return{}end,[105]=function()return{}end,[106]=function()return{}end,[107]=function()return{}end,[108]=function()return{}end,[109]=function()return{}end,[110]=function()return{}end,[111]=function()return{}end,[112]=function()return{}end,[113]=function()return{}end,[114]=function()return{}end,[115]=function()return{}end,[116]=function()return{}end,[117]=function()return{}end,[118]=function()return{}end,[119]=function()return{}end,[120]=function()return{}end,[121]=function()return{}end,[122]=function()return{}end,[123]=function()return{}end,[124]=function()return{}end,[125]=function()return{}end,[126]=function()return{}end,[127]=function()return{}end,[128]=function()return{}end,[129]=function()return{}end,[130]=function()return{}end,[131]=function()return{}end,[132]=function()return{}end,[133]=function()return{}end,[134]=function()return{}end,[135]=function()return{}end,[136]=function()return{}end,[137]=function()return{}end,[138]=function()return{}end,[139]=function()return{}end,[140]=function()return{}end,[141]=function()return{}end,[142]=function()return{}end,[143]=function()return{}end,[144]=function()return{}end,[145]=function()return{}end,[146]=function()return{}end,[147]=function()return{}end,[148]=function()return{}end,[149]=function()return{}end,[150]=function()return{}end,[151]=function()return{}end,[152]=function()return{}end,[153]=function()return{}end,[154]=function()return{}end,[155]=function()return{}end,[156]=function()return{}end,[157]=function()return{}end,[158]=function()return{}end,[159]=function()return{}end,[160]=function()return{}end,[161]=function()return{}end,[162]=function()return{}end,[163]=function()return{}end,[164]=function()return{}end,[165]=function()return{}end,[166]=function()return{}end,[167]=function()return{}end,[168]=function()return{}end,[169]=function()return{}end,[170]=function()return{}end,[171]=function()return{}end,[172]=function()return{}end,[173]=function()return{}end,[174]=function()return{}end,[175]=function()return{}end,[176]=function()return{}end,[177]=function()return{}end,[178]=function()return{}end,[179]=function()return{}end,[180]=function()return{}end,[181]=function()return{}end,[182]=function()return{}end,[183]=function()return{}end,[184]=function()return{}end,[185]=function()return{}end,[186]=function()return{}end,[187]=function()return{}end,[188]=function()return{}end,[189]=function()return{}end,[190]=function()return{}end,[191]=function()return{}end,[192]=function()return{}end,[193]=function()return{}end,[194]=function()return{}end,[195]=function()return{}end,[196]=function()return{}end}local function d(a)local a={a,1}function a:r(a,b)if b==nil then b=self[2]self[2]=self[2]+string.packsize(a)end;if b>#self[1]then return nil end;local a={string.unpack(a,string.sub(self[1],b,b+string.packsize(a)-1))}table.remove(a,#a)return table.unpack(a)end;function a:w(a,b,c)if c==nil then c=self[2]self[2]=self[2]+string.packsize(a)end;if c<0 then error(("[lasm - error] Tried to write value %s to a negative address %d"):format(b,c))end;local a=string.pack(a,b)if c<#self[1]then self[1]=string.sub(self[1],1,c-1)..a..string.sub(self[1],c+#a)end;local b=c-#self[1]-1;local d=""if b>0 then d=string.rep("\0",b)end;self[1]=string.sub(self[1],1,c-1)..d..a..string.sub(self[1],c+#a)end;function a:rL128(a)local b=0;local c=0;local d;while true do d=self:r("B")b=bit32.bor(b,bit32.lshift(bit32.band(d,127),c))c=c+7;if bit32.band(d,128)==0 then break end end;if a and c<32 and(bit32.band(d,64)~=0)then b=bit32.bor(b,-bit32.lshift(1,c))if b>=2147483648 then b=b-4294967296 end end;return b end;function a:rV(a)local b=self:rL128()local c={}for b=1,b do local a=a()if a then table.insert(c,a)end end;return c end;function a:rS(b)b=b==nil and a:rL128()or b;return a:r(("c%d"):format(b))end;function a:sk(a)self[2]=self[2]+a end;function a:sC(a)self[2]=a end;function a:cR()return self[2]<#self[1]end;return a end;b=function(a)local b={}while true do local d=a:r("B")if d==11 then break end;local c=c[d]if c then local a=c(a)a.o=d;table.insert(b,a)else error(("[lasm - error(5)] 0x%X"):format(d))end end;return b end;local function c(a)local a=b(a)local a=a[1]if not a then return nil end;local b=a.v;if not a.v then return nil end;return b end;local function e(a)local e={}local a=d(a)if a:r("<i4")~=1836278016 then error("[lasm - error(1)]")end;if a:r("<i4")~=1 then error("[lasm - error(2)]")end;while a:cR()do local d=a:r("B")local f=a:rL128()if d==1 then e[1]=a:rV(function()local b=a:r("B")if b~=96 then error("[lasm - error(3)]")end;local b=a:rV(function()return a:r("B")end)local a=a:rV(function()return a:r("B")end)return{b,a}end)elseif d==2 then e[2]=a:rV(function()local b=a:rS()local c=a:rS()local d=a:r("B")local a=a:r("B")return{b,c,d,a}end)elseif d==3 then e[3]=a:rV(function()return{a:r("B")}end)elseif d==4 then e[4]=a:rV(function()local b=a:r("B")local c=a:r("B")local d=a:rL128()local a=c==1 and a:rL128()or math.huge;return{b,limits={d,a}}end)elseif d==5 then e[5]=a:rV(function()local b=a:r("B")local c=a:rL128()local a=b==1 and a:rL128()or math.huge;return{c,a}end)elseif d==6 then e[6]=a:rV(function()local b=a:r("B")local d=a:r("B")local a=c(a)return{b,d,a}end)elseif d==7 then e[7]=a:rV(function()local b=a:rS()local c=a:r("B")local a=a:rL128()return{b,c,a}end)elseif d==8 then if f>0 then e[8]=a:rL128()end elseif d==10 then e[10]=a:rV(function()local c=a:rL128()local c=a:rV(function()return{a:rL128(),a:r("B")}end)local a=b(a)return{c,a}end)elseif d==11 then e[11]=a:rV(function()local b=a:rL128()local d={0,{},nil,false}if b==2 then d[3]=a:rL128()end;if b==2 or b==0 then d[1]=c(a)d[4]=true end;d[2]=a:rV(function()return a:r("B")end)return d end)else error("[lasm - error(4)]")end end;return e end;local function b(a)if type(a)=="table"then a=string.pack(string.rep("B",#a),table.unpack(a))elseif type(a)~="string"then error("[lasm - error(0)]")end;local a=e(a)local b={p=a,s={},eM={},m={}}if a[11]then for a,a in next,a[11]do local a={a[1],#a[2],b=d(string.pack(string.rep("B",#a[2]),table.unpack(a[2])))}function a:t(a)return a-self[1]+1 end;function a:c(a)return a+1>self[1]and a<self[1]+self[2]+1 end;table.insert(b.m,a)end end;function b:ac(a,b)if#self.m==0 or b==true then local b=#self.m~=0 and(self.m[#self.m][1]+self.m[#self.m][1])or 0;local a={b,a,b=d(string.rep("\0",a)),true}function a:t(a)return a-self[1]+1 end;function a:c(a)return a+1>self[1]and a<self[1]+self[2]+1 end;table.insert(self.m,a)return b else for a,a in next,self.m do if a[4]==true then error("unimplemented")end end;return self:ac(a,true)end end;function b:gCS(a)for b,b in self.m do if b:c(a)then return b end end end;function b:exp(a,b,c)local d=self.eM[a]if not d then d={}self.eM[a]=d end;d[b]=c end;function b:ph(a)if a==nil then error("[lasm - error(7)]")end;table.insert(self.s,a)end;function b:pp()return table.remove(self.s,#self.s)end;function b:wfi(a)if a<#self.p[2]then local a=self.p[2][a+1]local b=self.p[1][a[4]+1]return function()local c={}for a=#b[1],1,-1 do c[a]=self:pp()end;local b=self.eM[a[1]]if not b then error("[lasm - error(8)]")end;local a=b[a[2]]if not a then error("[lasm - error(9)]")end;return a(table.unpack(c))end else local a=a-#self.p[2]local a=self.p[10][a+1]return function()return self:exeC(a[2],a[1])end end end;function b:exeC(a,b,c,d)d=d or-1;local c=c or{}local e=1;while true do if e>#a then break end;local a=a[e]e=e+1;if a.o==2 then local a=self:exeC(a.c,b,c,d+1)if a~=nil then if a==0 then return nil else return a-1 end end elseif a.o==3 then while true do local a=self:exeC(a.c,b,c,d+2)if a~=nil then if a==0 then continue else return a-1 end else break end end elseif a.o==12 then return a.l elseif a.o==13 then local b=self:pp()if b~=nil and b~=0 then return a.l end elseif a.o==15 then return d elseif a.o==16 then local a=a.x;local a=self:wfi(a)if a then local a={a()}for a,a in next,a do if a~=nil then self:ph(a)end end end elseif a.o==32 then self:ph(c[a.x])elseif a.o==33 then c[a.x]=self:pp()elseif a.o==34 then local b=self:pp()c[a.x]=b;self:ph(b)elseif a.o==45 then local a=self:pp()+a.m.o;local b=self:gCS(a)b.b:sC(b:t(a))self:ph(b.b:r("B"))elseif a.o==58 then local b=self:pp()local a=self:pp()+a.m.o;local c=self:gCS(a)c.b:sC(c:t(a))c.b:w("B",bit32.band(b,255))elseif a.o==65 or a.o==66 or a.o==67 or a.o==68 then self:ph(a.v)elseif a.o==69 then local a=self:pp()self:ph((a==0)and 1 or 0)elseif a.o==70 then local a=self:pp()local b=self:pp()self:ph((b==a)and 1 or 0)elseif a.o==71 then local a=self:pp()local b=self:pp()self:ph((b~=a)and 1 or 0)elseif a.o==73 then local a=string.unpack("<I",string.pack("<i",self:pp()))local b=string.unpack("<I",string.pack("<i",self:pp()))self:ph((b<a)and 1 or 0)elseif a.o==106 then local a=self:pp()local b=self:pp()self:ph(b+a)elseif a.o==108 then local a=self:pp()local b=self:pp()self:ph(b*a)elseif a.o==110 then local a=string.unpack("<I",string.pack("<i",self:pp()))local b=string.unpack("<I",string.pack("<i",self:pp()))self:ph(string.unpack("<I",string.pack("<i",b/a)))elseif a.o==112 then local a=string.unpack("<I",string.pack("<i",self:pp()))local b=string.unpack("<I",string.pack("<i",self:pp()))self:ph(string.unpack("<I",string.pack("<i",b%a)))elseif a.o==113 then local a=self:pp()local b=self:pp()self:ph(bit32.band(b,a))elseif a.o==114 then local a=self:pp()local b=self:pp()self:ph(bit32.bor(b,a))elseif a.o==115 then local a=self:pp()local b=self:pp()self:ph(bit32.bxor(b,a))elseif a.o==116 then local a=self:pp()local b=self:pp()self:ph(bit32.lshift(b,a))elseif a.o==118 then local a=string.unpack("<I",string.pack("<i",self:pp()))local b=string.unpack("<I",string.pack("<i",self:pp()))self:ph(string.unpack("<I",string.pack("<i",bit32.rshift(b,a))))elseif a.o==146 then local a=self:pp()local b=self:pp()self:ph(b+a)else error(("[lasm - error(10)] 0x%X"):format(a.o))end end end;function b:ge(a)local b;for c,c in next,self.p[7]do if c[1]==a then b=c end end;if not b then return nil end;if b[2]==0 then local a=b[3]-#(self.p[2]or{})+1;local a={b[1],self.p[10][a],self.p[1][self.p[3][a][1]+1]}return setmetatable(a,{__tostring=function(a)return("(lasm) %s"):format(a.name)end,__call=function(a,...)local b={...}local c={}for a=1,#a[3][1]do if b[a]==nil then error("[lasm - error(11)]")end;c[a-1]=b[a]end;self:exeC(a[2][2],a[2][1],c)local b={}for a=1,#a[3][2]do table.insert(b,self:pp())end;return table.unpack(b)end})else return b end end;return b end;local b=b({0,97,115,109,1,0,0,0,1,7,1,96,3,127,127,127,0,3,2,1,0,4,5,1,112,1,1,1,5,3,1,0,17,6,25,3,127,1,65,128,128,192,0,11,127,0,65,131,128,192,0,11,127,0,65,144,128,192,0,11,7,47,4,6,109,101,109,111,114,121,2,0,7,101,110,99,114,121,112,116,0,0,10,95,95,100,97,116,97,95,101,110,100,3,1,11,95,95,104,101,97,112,95,98,97,115,101,3,2,10,85,1,83,1,2,127,2,64,32,1,69,13,0,65,0,33,3,3,64,32,2,32,3,106,32,3,65,3,110,65,125,108,32,3,106,65,128,128,192,128,0,106,45,0,0,32,3,106,32,0,32,3,106,45,0,0,34,4,65,3,116,32,4,65,5,118,114,106,58,0,0,32,1,32,3,65,1,106,34,3,71,13,0,11,11,11,11,12,1,0,65,128,128,192,0,11,3,192,48,69})local c=#INPUT_STRING;local d=b:ac(c)local e=b:gCS(d)e.b:sC(e:t(d))e.b:w("c"..tostring(c),INPUT_STRING)b:ge("encrypt")(d,c,d)e.b:sC(e:t(d))local a=e.b:r("c"..tostring(c))e.b:sC(e:t(d))local b={e.b:r(string.rep("B",c))}for a,c in next,b do b[a]=("0x%X"):format(c)end;local b=table.concat(b,", ")print(("Encrypted (bytes): [ %s ]"):format(b))print(("Encrypted (char): %q"):format(a))end)()